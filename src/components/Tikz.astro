---
const { code } = Astro.props;
const id = `tikz-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="tikz-container" id={id}>
  <div class="tikz-loading">Loading LaTeX...</div>
  <textarea style="display:none;" class="tikz-code">{code}</textarea>
</div>

<script is:inline src="https://tikzjax.com/v1/tikzjax.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('.tikz-container');
    containers.forEach(container => {
      const textarea = container.querySelector('.tikz-code');
      if (textarea) {
        const code = textarea.value;
        const script = document.createElement('script');
        script.type = 'text/tikz';
        script.setAttribute('data-show-console', 'true');
        script.textContent = code;
        container.appendChild(script);
        
        // Watch for SVG to be added
        const loading = container.querySelector('.tikz-loading');
        if (loading) {
          const observer = new MutationObserver((mutations) => {
            const svg = container.querySelector('svg');
            if (svg) {
              // Fix the pipe character mapping issue
              svg.querySelectorAll('text').forEach(text => {
                // Replace clubs (♣) with pipes
                text.textContent = text.textContent.replace(/♣/g, '|');
                // Also check for em-dash if that appears
                text.textContent = text.textContent.replace(/—/g, '|');
                // And replace 'j' if \textbar was used
                // Be careful with this one - only in math context
              });
              
              loading.remove();
              observer.disconnect();
            }
          });
          
          observer.observe(container, {
            childList: true,
            subtree: true
          });
        }
      }
    });
  });
</script>

<style>
  .tikz-container {
    display: flex;
    justify-content: center;
    margin: 2rem 0;
    position: relative;
  }
  .tikz-loading {
    color: #666;
    font-style: italic;
    padding: 1rem;
  }
</style>
